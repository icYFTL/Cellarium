name: Cellarium dpkg CI
on: 
  push:
    branches: [master]
jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        dotnet-version: ['6.x.x']
    permissions:
      contents: write
        
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Setup .NET SDK ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
      - name: Install dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release --no-restore
      - run: echo "Creating directories..."
      - run: mkdir -p ./package/DEBIAN
      - run: "echo 'Package: Cellarium\nVersion: 1.0\nSection: unknown\nPriority: optional\nDepends: libc6\nArchitecture: amd64\nEssential: no\nInstalled-Size: 20\nMaintainer: icyftl\nDescription: File manager for yandex drive' >> ./package/DEBIAN/control"
      - run: mkdir -p ./package/usr/cellarium
      - run: mkdir -p ./package/usr/bin
      - run: mv Cellarium/bin/Release/net6.0/* ./package/usr/cellarium
      - run: ln -s ./package/usr/cellarium/Cellarium ./package/usr/bin/cellarium
      - run: "echo 'apt update && apt install -y libpthread-stubs0-dev libc6 libstdc++6 libc6 gcc-multilib' >> ./package/DEBIAN/postinst"
      - run: dpkg-deb --build ./package
      - run: echo "done"